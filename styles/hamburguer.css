(function () {
  'use strict';

  function initHeader() {
    const hamburger = document.getElementById('hamburger');
    const navList = document.getElementById('navList');
    const navItems = document.querySelectorAll('.nav__item');
    const breakpointMobile = 900;
    
    let isMobile = window.innerWidth <= breakpointMobile;
    let isMenuOpen = false;
    let hoverTimeouts = new Map();

    console.log('Header initialization started');

    // Limpar todos os timeouts
    function clearAllTimeouts() {
      hoverTimeouts.forEach(timeout => clearTimeout(timeout));
      hoverTimeouts.clear();
    }

    // Fechar todos os dropdowns
    function closeAllDropdowns() {
      console.log('Closing all dropdowns');
      navItems.forEach(item => {
        item.classList.remove('open');
        const link = item.querySelector('.nav__link');
        const dropdown = item.querySelector('.dropdown, .mega-menu');
        
        if (link) link.setAttribute('aria-expanded', 'false');
        if (dropdown) dropdown.setAttribute('aria-hidden', 'true');
      });
      clearAllTimeouts();
    }

    // Fechar menu mobile
    function closeMobileMenu() {
      console.log('Closing mobile menu');
      if (navList) {
        navList.classList.remove('nav__list--open');
        isMenuOpen = false;
      }
      if (hamburger) {
        hamburger.classList.remove('active');
        hamburger.setAttribute('aria-expanded', 'false');
      }
      // Liberar scroll do body
      document.body.classList.remove('menu-open');
      document.body.style.removeProperty('overflow');
      document.body.style.removeProperty('position');
      document.body.style.removeProperty('width');
      document.body.style.removeProperty('height');
      
      closeAllDropdowns();
    }

    // Abrir menu mobile
    function openMobileMenu() {
      console.log('Opening mobile menu');
      if (navList) {
        navList.classList.add('nav__list--open');
        isMenuOpen = true;
      }
      if (hamburger) {
        hamburger.classList.add('active');
        hamburger.setAttribute('aria-expanded', 'true');
      }
      // Bloquear scroll do body
      document.body.classList.add('menu-open');
    }

    // Toggle menu mobile
    function toggleMobileMenu() {
      console.log('Toggling mobile menu, current state:', isMenuOpen);
      if (isMenuOpen) {
        closeMobileMenu();
      } else {
        openMobileMenu();
      }
    }

    // Abrir dropdown
    function openDropdown(item) {
      const link = item.querySelector('.nav__link');
      const dropdown = item.querySelector('.dropdown, .mega-menu');
      
      item.classList.add('open');
      if (link) link.setAttribute('aria-expanded', 'true');
      if (dropdown) dropdown.setAttribute('aria-hidden', 'false');
    }

    // Fechar dropdown específico
    function closeDropdown(item) {
      const link = item.querySelector('.nav__link');
      const dropdown = item.querySelector('.dropdown, .mega-menu');
      
      item.classList.remove('open');
      if (link) link.setAttribute('aria-expanded', 'false');
      if (dropdown) dropdown.setAttribute('aria-hidden', 'true');
    }

    // Setup do hamburger
    if (hamburger && navList) {
      hamburger.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        toggleMobileMenu();
      });

      hamburger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleMobileMenu();
        }
        if (e.key === 'Escape' && isMenuOpen) {
          closeMobileMenu();
        }
      });
    }

    // Fechar menu ao clicar fora
    document.addEventListener('click', (e) => {
      const clickedInside = e.target.closest('.header__inner');
      const clickedOnNav = e.target.closest('.nav__item');
      const clickedOnDropdown = e.target.closest('.mega-menu, .dropdown');
      
      if (isMobile && isMenuOpen && !clickedInside) {
        closeMobileMenu();
      }
      
      if (!isMobile && !clickedOnNav && !clickedOnDropdown) {
        closeAllDropdowns();
      }
    });

    // Handle Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (isMobile && isMenuOpen) {
          closeMobileMenu();
          if (hamburger) hamburger.focus();
        } else {
          closeAllDropdowns();
        }
      }
    });

    // Setup de cada item de navegação
    navItems.forEach((item, index) => {
      const link = item.querySelector('.nav__link');
      const dropdown = item.querySelector('.dropdown, .mega-menu');
      const hasDropdown = !!dropdown;

      if (!link) return;

      // Inicializar ARIA
      link.setAttribute('aria-expanded', 'false');
      if (hasDropdown) {
        link.setAttribute('aria-haspopup', 'true');
        dropdown.setAttribute('aria-hidden', 'true');
      }

      // DESKTOP: Hover behavior
      if (hasDropdown) {
        const handleMouseEnter = () => {
          if (isMobile) return;
          
          console.log(`Mouse enter on item ${index}`);
          clearAllTimeouts();
          closeAllDropdowns();
          openDropdown(item);
        };

        const handleMouseLeave = () => {
          if (isMobile) return;
          
          console.log(`Mouse leave from item ${index}`);
          
          const timeoutId = setTimeout(() => {
            if (!item.matches(':hover')) {
              closeDropdown(item);
            }
          }, 150);
          
          hoverTimeouts.set(item, timeoutId);
        };

        const handleFocusIn = () => {
          if (isMobile) return;
          
          console.log(`Focus in on item ${index}`);
          clearAllTimeouts();
          closeAllDropdowns();
          openDropdown(item);
        };

        const handleFocusOut = (e) => {
          if (isMobile) return;
          
          const timeoutId = setTimeout(() => {
            if (!item.contains(document.activeElement)) {
              console.log(`Focus out from item ${index}`);
              closeDropdown(item);
            }
          }, 100);
          
          hoverTimeouts.set(item, timeoutId);
        };

        item.addEventListener('mouseenter', handleMouseEnter);
        item.addEventListener('mouseleave', handleMouseLeave);
        item.addEventListener('focusin', handleFocusIn);
        item.addEventListener('focusout', handleFocusOut);
      }

      // MOBILE: Click behavior
      link.addEventListener('click', (e) => {
        console.log(`Link clicked on item ${index}, isMobile: ${isMobile}, hasDropdown: ${hasDropdown}`);
        
        if (isMobile && hasDropdown) {
          e.preventDefault();
          e.stopPropagation();
          
          const isOpen = item.classList.contains('open');
          
          // Fechar outros dropdowns
          navItems.forEach(other => {
            if (other !== item) {
              closeDropdown(other);
            }
          });
          
          // Toggle dropdown atual
          if (isOpen) {
            closeDropdown(item);
          } else {
            openDropdown(item);
          }
        } else if (isMobile && !hasDropdown) {
          // Links regulares no mobile fecham o menu
          console.log('Regular link click on mobile, closing menu');
          setTimeout(() => closeMobileMenu(), 100);
        }
      });

      // Keyboard support para mobile
      link.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter' || e.key === ' ') && isMobile && hasDropdown) {
          e.preventDefault();
          link.click();
        }
      });
    });

    // Prevenir scroll no touch quando menu estiver aberto
    if (navList) {
      let startY = 0;
      
      navList.addEventListener('touchstart', (e) => {
        startY = e.touches[0].pageY;
      }, { passive: true });
      
      navList.addEventListener('touchmove', (e) => {
        const currentY = e.touches[0].pageY;
        const scrollTop = navList.scrollTop;
        const scrollHeight = navList.scrollHeight;
        const clientHeight = navList.clientHeight;
        
        // Prevenir overscroll
        if (scrollTop <= 0 && currentY > startY) {
          // Tentando scroll up quando já está no topo
          e.preventDefault();
        } else if (scrollTop + clientHeight >= scrollHeight && currentY < startY) {
          // Tentando scroll down quando já está no fim
          e.preventDefault();
        }
      }, { passive: false });
    }

    // Handle resize
    function handleResize() {
      const wasMobile = isMobile;
      isMobile = window.innerWidth <= breakpointMobile;
      
      console.log(`Resize: wasMobile=${wasMobile}, isMobile=${isMobile}, width=${window.innerWidth}`);
      
      if (wasMobile !== isMobile) {
        // Mudou de modo
        closeMobileMenu();
        closeAllDropdowns();
        
        if (!isMobile) {
          console.log('Switched to desktop mode');
        } else {
          console.log('Switched to mobile mode');
        }
      }
    }

    // Debounced resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(handleResize, 150);
    });
    
    window.addEventListener('orientationchange', () => {
      setTimeout(handleResize, 200);
    });

    // Inicialização
    handleResize();
    console.log('Header initialization complete. Initial mode:', isMobile ? 'mobile' : 'desktop');
  }

  // Initialize quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeader);
  } else {
    initHeader();
  }
})();
