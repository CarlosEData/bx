(function () {
    'use strict';

    function initHeader() {
        // Core Elements
        const hamburger = document.getElementById('hamburger');
        const navList = document.getElementById('navList');
        const navItems = document.querySelectorAll('.nav__item');
        const header = document.querySelector('.header');
        const breakpointMobile = 900;

        // State Management
        let isMobile = window.innerWidth <= breakpointMobile;
        let isMenuOpen = false;
        let hoverTimeout = null;
        let isTransitioning = false;

        console.log('Header initialization started. Initial mode:', isMobile ? 'mobile' : 'desktop');

        // ==================== UTILITY FUNCTIONS ====================

        /**
         * Debounce function to limit how often a function can fire
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * Lock body scroll when mobile menu is open
         */
        function lockBodyScroll(shouldLock) {
            if (shouldLock) {
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
            } else {
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
            }
        }

        // ==================== CORE NAVIGATION FUNCTIONS ====================

        /**
         * Closes all dropdowns and resets ARIA attributes
         */
        function closeAllDropdowns() {
            console.log('Closing all dropdowns');
            navItems.forEach(item => {
                const link = item.querySelector('.nav__link');
                const dropdown = item.querySelector('.dropdown, .mega-menu');
                
                item.classList.remove('open');
                if (link) link.setAttribute('aria-expanded', 'false');
                if (dropdown) dropdown.setAttribute('aria-hidden', 'true');
            });
        }

        /**
         * Toggles a specific dropdown open/closed
         */
        function toggleDropdown(item) {
            if (isTransitioning) return;
            
            const link = item.querySelector('.nav__link');
            const dropdown = item.querySelector('.dropdown, .mega-menu');
            const isOpening = !item.classList.contains('open');
            
            // Close other dropdowns before opening a new one
            if (isOpening && isMobile) {
                closeAllDropdowns();
            }
            
            // Toggle the current dropdown
            if (isOpening) {
                item.classList.add('open');
                if (link) link.setAttribute('aria-expanded', 'true');
                if (dropdown) dropdown.setAttribute('aria-hidden', 'false');
            } else {
                item.classList.remove('open');
                if (link) link.setAttribute('aria-expanded', 'false');
                if (dropdown) dropdown.setAttribute('aria-hidden', 'true');
            }
        }

        /**
         * Closes mobile menu completely
         */
        function closeMobileMenu() {
            if (!isMenuOpen || isTransitioning) return;
            
            console.log('Closing mobile menu');
            isTransitioning = true;
            
            if (navList) {
                navList.classList.remove('nav__list--open');
            }
            if (hamburger) {
                hamburger.classList.remove('active');
                hamburger.setAttribute('aria-expanded', 'false');
            }
            
            // Unlock body scroll
            lockBodyScroll(false);
            
            // Close all dropdowns
            closeAllDropdowns();
            
            // Reset state after transition
            setTimeout(() => {
                isMenuOpen = false;
                isTransitioning = false;
            }, 300);
        }

        /**
         * Opens mobile menu
         */
        function openMobileMenu() {
            if (isMenuOpen || isTransitioning) return;
            
            console.log('Opening mobile menu');
            isTransitioning = true;
            
            if (navList) {
                navList.classList.add('nav__list--open');
            }
            if (hamburger) {
                hamburger.classList.add('active');
                hamburger.setAttribute('aria-expanded', 'true');
            }
            
            // Lock body scroll to prevent background scrolling
            lockBodyScroll(true);
            
            // Reset state after transition
            setTimeout(() => {
                isMenuOpen = true;
                isTransitioning = false;
            }, 300);
        }

        /**
         * Toggles mobile menu state
         */
        function toggleMobileMenu() {
            if (isTransitioning) return;
            
            console.log('Toggling mobile menu. Current state:', isMenuOpen);
            
            if (isMenuOpen) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        // ==================== EVENT HANDLERS ====================

        /**
         * Setup hamburger menu interactions
         */
        function setupHamburgerMenu() {
            if (!hamburger || !navList) return;
            
            // Click handler
            hamburger.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMobileMenu();
            });
            
            // Keyboard navigation
            hamburger.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleMobileMenu();
                }
                if (e.key === 'Escape' && isMenuOpen) {
                    closeMobileMenu();
                    hamburger.focus();
                }
            });
        }

        /**
         * Setup desktop hover interactions with delay
         */
        function setupDesktopHover() {
            if (isMobile) return;
            
            navItems.forEach(item => {
                const hasDropdown = item.querySelector('.dropdown, .mega-menu');
                
                if (!hasDropdown) return;
                
                // Mouse enter with 300ms delay [citation:7]
                item.addEventListener('mouseenter', () => {
                    clearTimeout(hoverTimeout);
                    hoverTimeout = setTimeout(() => {
                        closeAllDropdowns();
                        toggleDropdown(item);
                    }, 300);
                });
                
                // Mouse leave with delay to prevent flickering [citation:7]
                item.addEventListener('mouseleave', () => {
                    clearTimeout(hoverTimeout);
                    hoverTimeout = setTimeout(() => {
                        if (!item.matches(':hover') && !item.querySelector('.dropdown, .mega-menu')?.matches(':hover')) {
                            toggleDropdown(item);
                        }
                    }, 150);
                });
                
                // Keep dropdown open when hovering over it
                const dropdown = item.querySelector('.dropdown, .mega-menu');
                if (dropdown) {
                    dropdown.addEventListener('mouseenter', () => {
                        clearTimeout(hoverTimeout);
                    });
                    
                    dropdown.addEventListener('mouseleave', () => {
                        clearTimeout(hoverTimeout);
                        hoverTimeout = setTimeout(() => {
                            toggleDropdown(item);
                        }, 150);
                    });
                }
            });
        }

        /**
         * Setup click handlers for mobile navigation
         */
        function setupMobileClickHandlers() {
            if (!isMobile) return;
            
            navItems.forEach(item => {
                const link = item.querySelector('.nav__link');
                const hasDropdown = item.querySelector('.dropdown, .mega-menu');
                
                if (!link) return;
                
                // Click handler for links with dropdowns
                link.addEventListener('click', (e) => {
                    if (hasDropdown) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleDropdown(item);
                    } else {
                        // Regular links close the menu on mobile
                        closeMobileMenu();
                    }
                });
                
                // Keyboard support
                link.addEventListener('keydown', (e) => {
                    if ((e.key === 'Enter' || e.key === ' ') && hasDropdown) {
                        e.preventDefault();
                        toggleDropdown(item);
                    }
                });
            });
        }

        /**
         * Setup global click and keyboard handlers
         */
        function setupGlobalHandlers() {
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                const clickedInsideNav = e.target.closest('.nav__list') || e.target.closest('.header__inner');
                const clickedHamburger = e.target.closest('#hamburger');
                
                if (isMobile && isMenuOpen && !clickedInsideNav && !clickedHamburger) {
                    closeMobileMenu();
                }
                
                if (!isMobile && !clickedInsideNav) {
                    closeAllDropdowns();
                }
            });
            
            // Escape key handler
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (isMobile && isMenuOpen) {
                        closeMobileMenu();
                        if (hamburger) hamburger.focus();
                    } else {
                        closeAllDropdowns();
                    }
                }
            });
            
            // Tab key trapping for accessibility
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab' && isMenuOpen && isMobile) {
                    const focusableElements = navList.querySelectorAll(
                        'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])'
                    );
                    
                    if (focusableElements.length === 0) return;
                    
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey && document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            });
        }

        /**
         * Initialize ARIA attributes for accessibility
         */
        function initializeARIA() {
            navItems.forEach((item, index) => {
                const link = item.querySelector('.nav__link');
                const dropdown = item.querySelector('.dropdown, .mega-menu');
                
                if (!link) return;
                
                // Set initial ARIA attributes
                if (dropdown) {
                    link.setAttribute('aria-haspopup', 'true');
                    link.setAttribute('aria-expanded', 'false');
                    link.setAttribute('aria-controls', `dropdown-${index}`);
                    dropdown.setAttribute('id', `dropdown-${index}`);
                    dropdown.setAttribute('aria-hidden', 'true');
                    dropdown.setAttribute('aria-labelledby', link.id || `nav-link-${index}`);
                }
                
                // Add unique IDs if not present
                if (!link.id) {
                    link.id = `nav-link-${index}`;
                }
            });
            
            // Setup hamburger ARIA
            if (hamburger) {
                hamburger.setAttribute('aria-label', 'Menu de navegação');
                hamburger.setAttribute('aria-expanded', 'false');
                hamburger.setAttribute('aria-controls', 'navList');
            }
        }

        /**
         * Handle window resize and orientation changes
         */
        function setupResponsiveHandlers() {
            const handleResize = debounce(() => {
                const wasMobile = isMobile;
                isMobile = window.innerWidth <= breakpointMobile;
                
                console.log(`Resize: wasMobile=${wasMobile}, isMobile=${isMobile}, width=${window.innerWidth}`);
                
                if (wasMobile !== isMobile) {
                    // Mode changed - reset everything
                    closeMobileMenu();
                    closeAllDropdowns();
                    
                    if (isMobile) {
                        console.log('Switched to mobile mode');
                    } else {
                        console.log('Switched to desktop mode');
                    }
                }
            }, 150);
            
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', () => {
                setTimeout(handleResize, 200);
            });
        }

        // ==================== INITIALIZATION ====================

        /**
         * Initialize all navigation functionality
         */
        function initializeNavigation() {
            console.log('Initializing navigation...');
            
            // 1. Setup ARIA for accessibility [citation:2][citation:10]
            initializeARIA();
            
            // 2. Setup hamburger menu
            setupHamburgerMenu();
            
            // 3. Setup event handlers based on current mode
            if (isMobile) {
                setupMobileClickHandlers();
            } else {
                setupDesktopHover();
            }
            
            // 4. Setup global handlers
            setupGlobalHandlers();
            
            // 5. Setup responsive behavior
            setupResponsiveHandlers();
            
            console.log('Navigation initialization complete');
        }

        // Start initialization
        initializeNavigation();
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initHeader);
    } else {
        initHeader();
    }
})();
